import React, { useState, useEffect } from 'react';
import { TreeDeciduous, Home, Factory, Mountain, Waves, Zap, DollarSign, Users, Trophy, Crown } from 'lucide-react';

const TERRAIN_TYPES = {
  sea: { name: 'Êµ∑', color: 'bg-blue-400', icon: null },
  plains: { name: 'Âπ≥Âú∞', color: 'bg-green-200', icon: null },
  forest: { name: 'Ê£Æ', color: 'bg-green-600', icon: TreeDeciduous },
  town: { name: 'Áî∫', color: 'bg-gray-400', icon: Home },
  city: { name: 'ÈÉΩÂ∏Ç', color: 'bg-gray-600', icon: Factory },
  mountain: { name: 'Â±±', color: 'bg-gray-700', icon: Mountain },
  factory: { name: 'Â∑•Â†¥', color: 'bg-yellow-600', icon: Factory },
  farm: { name: 'Ëæ≤Â†¥', color: 'bg-yellow-300', icon: null }
};

const COMMANDS = [
  { id: 'reclaim', name: 'Êï¥Âú∞', cost: 5, description: 'Êµ∑„ÇíÂπ≥Âú∞„Å´„Åô„Çã' },
  { id: 'plant', name: 'Ê§çÊûó', cost: 50, description: 'Âπ≥Âú∞„Å´Ê£Æ„Çí‰Ωú„Çã' },
  { id: 'build_town', name: 'Áî∫Âª∫Ë®≠', cost: 100, description: 'Âπ≥Âú∞„Å´Áî∫„ÇíÂª∫Ë®≠' },
  { id: 'build_factory', name: 'Â∑•Â†¥Âª∫Ë®≠', cost: 200, description: 'Âπ≥Âú∞„Å´Â∑•Â†¥„ÇíÂª∫Ë®≠' },
  { id: 'build_farm', name: 'Ëæ≤Â†¥Âª∫Ë®≠', cost: 150, description: 'Âπ≥Âú∞„Å´Ëæ≤Â†¥„ÇíÂª∫Ë®≠' }
];

const PLAYER_COLORS = [
  'border-red-500',
  'border-blue-500',
  'border-green-500',
  'border-yellow-500',
  'border-purple-500',
  'border-pink-500'
];

const HakoniwaIslands = () => {
  const [gameState, setGameState] = useState('setup'); // setup, playing, ended
  const [players, setPlayers] = useState([]);
  const [currentPlayerIndex, setCurrentPlayerIndex] = useState(0);
  const [globalTurn, setGlobalTurn] = useState(0);
  const [selectedCommand, setSelectedCommand] = useState(null);
  const [logs, setLogs] = useState([]);
  const [playerName, setPlayerName] = useState('');
  const [winner, setWinner] = useState(null);

  const createInitialGrid = () => {
    const grid = [];
    for (let y = 0; y < 10; y++) {
      const row = [];
      for (let x = 0; x < 10; x++) {
        if (x === 0 || x === 9 || y === 0 || y === 9) {
          row.push('sea');
        } else if (x >= 4 && x <= 5 && y >= 4 && y <= 5) {
          row.push('town');
        } else if (Math.random() > 0.7) {
          row.push('forest');
        } else {
          row.push('plains');
        }
      }
      grid.push(row);
    }
    return grid;
  };

  const addPlayer = () => {
    if (playerName.trim() && players.length < 6) {
      const newPlayer = {
        id: Date.now(),
        name: playerName.trim(),
        funds: 1000,
        population: 100,
        grid: createInitialGrid(),
        score: 0,
        color: PLAYER_COLORS[players.length]
      };
      setPlayers([...players, newPlayer]);
      setPlayerName('');
      addLog(`${newPlayer.name}„ÅåÂèÇÂä†„Åó„Åæ„Åó„ÅüÔºÅ`);
    }
  };

  const startGame = () => {
    if (players.length >= 2) {
      setGameState('playing');
      addLog('„Ç≤„Éº„É†ÈñãÂßãÔºÅ');
    }
  };

  const addLog = (message) => {
    setLogs(prev => [{ turn: globalTurn, message }, ...prev.slice(0, 19)]);
  };

  const calculateScore = (player) => {
    return player.funds + player.population * 2;
  };

  const handleCellClick = (x, y) => {
    if (gameState !== 'playing') return;
    
    const currentPlayer = players[currentPlayerIndex];
    if (!selectedCommand) {
      addLog('„Ç≥„Éû„É≥„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      return;
    }

    const currentTerrain = currentPlayer.grid[y][x];
    const command = COMMANDS.find(c => c.id === selectedCommand);

    if (currentPlayer.funds < command.cost) {
      addLog(`${currentPlayer.name}: Ë≥áÈáë„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ`);
      return;
    }

    let newTerrain = null;
    let success = false;

    switch (selectedCommand) {
      case 'reclaim':
        if (currentTerrain === 'sea') {
          newTerrain = 'plains';
          success = true;
        }
        break;
      case 'plant':
        if (currentTerrain === 'plains') {
          newTerrain = 'forest';
          success = true;
        }
        break;
      case 'build_town':
        if (currentTerrain === 'plains') {
          newTerrain = 'town';
          success = true;
        }
        break;
      case 'build_factory':
        if (currentTerrain === 'plains') {
          newTerrain = 'factory';
          success = true;
        }
        break;
      case 'build_farm':
        if (currentTerrain === 'plains') {
          newTerrain = 'farm';
          success = true;
        }
        break;
    }

    if (success && newTerrain) {
      const newGrid = currentPlayer.grid.map((row, rowIndex) =>
        rowIndex === y ? row.map((cell, colIndex) =>
          colIndex === x ? newTerrain : cell
        ) : row
      );

      const updatedPlayers = players.map((p, idx) =>
        idx === currentPlayerIndex
          ? { ...p, grid: newGrid, funds: p.funds - command.cost }
          : p
      );

      setPlayers(updatedPlayers);
      addLog(`${currentPlayer.name}: ${command.name}„ÇíÂÆüË°å (${x}, ${y})`);
    } else {
      addLog(`${currentPlayer.name}: „Åù„Åì„Å´„ÅØÂª∫Ë®≠„Åß„Åç„Åæ„Åõ„Çì`);
    }
  };

  const endTurn = () => {
    const currentPlayer = players[currentPlayerIndex];
    let newFunds = currentPlayer.funds;
    let newPopulation = currentPlayer.population;

    currentPlayer.grid.forEach(row => {
      row.forEach(cell => {
        switch (cell) {
          case 'town':
            newFunds += 10;
            newPopulation += 10;
            break;
          case 'city':
            newFunds += 30;
            newPopulation += 30;
            break;
          case 'factory':
            newFunds += 50;
            break;
          case 'farm':
            newFunds += 20;
            break;
          case 'forest':
            newFunds += 2;
            break;
        }
      });
    });

    const foodCost = Math.floor(newPopulation / 10);
    newFunds -= foodCost;

    const updatedPlayers = players.map((p, idx) =>
      idx === currentPlayerIndex
        ? { ...p, funds: Math.max(0, newFunds), population: newPopulation, score: calculateScore({ funds: newFunds, population: newPopulation }) }
        : p
    );

    setPlayers(updatedPlayers);

    const nextPlayerIndex = (currentPlayerIndex + 1) % players.length;
    setCurrentPlayerIndex(nextPlayerIndex);

    if (nextPlayerIndex === 0) {
      const newGlobalTurn = globalTurn + 1;
      setGlobalTurn(newGlobalTurn);
      addLog(`===== „Çø„Éº„É≥ ${newGlobalTurn} ÁµÇ‰∫Ü =====`);

      if (newGlobalTurn >= 20) {
        endGame(updatedPlayers);
      }
    }

    setSelectedCommand(null);
  };

  const endGame = (finalPlayers) => {
    const sortedPlayers = [...finalPlayers].sort((a, b) => b.score - a.score);
    setWinner(sortedPlayers[0]);
    setGameState('ended');
    addLog(`üéâ „Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅÂÑ™Âãù: ${sortedPlayers[0].name}`);
  };

  const resetGame = () => {
    setPlayers([]);
    setCurrentPlayerIndex(0);
    setGlobalTurn(0);
    setGameState('setup');
    setLogs([]);
    setWinner(null);
  };

  const TerrainCell = ({ terrain, x, y }) => {
    const terrainInfo = TERRAIN_TYPES[terrain];
    const Icon = terrainInfo.icon;

    return (
      <div
        onClick={() => handleCellClick(x, y)}
        className={`${terrainInfo.color} w-10 h-10 border border-gray-300 cursor-pointer hover:opacity-80 flex items-center justify-center transition-all`}
        title={`${terrainInfo.name} (${x}, ${y})`}
      >
        {Icon && <Icon size={16} className="text-white" />}
      </div>
    );
  };

  const currentPlayer = players[currentPlayerIndex];
  const rankedPlayers = [...players].sort((a, b) => b.score - a.score);

  if (gameState === 'setup') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-100 to-green-100 p-8 flex items-center justify-center">
        <div className="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full">
          <h1 className="text-4xl font-bold text-center mb-6 text-gray-800">ÁÆ±Â∫≠Ë´∏Â≥∂ ÂØæÊà¶„É¢„Éº„Éâ</h1>
          
          <div className="space-y-4 mb-6">
            <div className="flex gap-2">
              <input
                type="text"
                value={playerName}
                onChange={(e) => setPlayerName(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && addPlayer()}
                placeholder="„Éó„É¨„Ç§„É§„ÉºÂêç„ÇíÂÖ•Âäõ"
                className="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 outline-none"
                maxLength={20}
              />
              <button
                onClick={addPlayer}
                disabled={players.length >= 6}
                className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 font-semibold"
              >
                ËøΩÂä†
              </button>
            </div>

            <div className="bg-gray-50 rounded-lg p-4 min-h-[120px]">
              <h3 className="font-bold mb-2 text-gray-700">ÂèÇÂä†„Éó„É¨„Ç§„É§„Éº ({players.length}/6)</h3>
              {players.length === 0 ? (
                <p className="text-gray-500 text-sm">ÊúÄ‰Ωé2‰∫∫„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅåÂøÖË¶Å„Åß„Åô</p>
              ) : (
                <ul className="space-y-2">
                  {players.map((player, idx) => (
                    <li key={player.id} className={`flex items-center gap-2 border-l-4 ${player.color} pl-2`}>
                      <span className="font-semibold">{idx + 1}.</span> {player.name}
                    </li>
                  ))}
                </ul>
              )}
            </div>
          </div>

          <button
            onClick={startGame}
            disabled={players.length < 2}
            className="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 disabled:bg-gray-400 font-bold text-lg"
          >
            „Ç≤„Éº„É†ÈñãÂßã (20„Çø„Éº„É≥Âà∂)
          </button>
        </div>
      </div>
    );
  }

  if (gameState === 'ended') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-yellow-100 to-orange-100 p-8 flex items-center justify-center">
        <div className="bg-white rounded-lg shadow-2xl p-8 max-w-2xl w-full">
          <div className="text-center mb-8">
            <Crown className="w-20 h-20 mx-auto mb-4 text-yellow-500" />
            <h1 className="text-4xl font-bold mb-2 text-gray-800">„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ</h1>
            <p className="text-2xl text-gray-600">ÂÑ™Âãù: {winner?.name}</p>
          </div>

          <div className="space-y-3 mb-8">
            {rankedPlayers.map((player, idx) => (
              <div
                key={player.id}
                className={`flex items-center justify-between p-4 rounded-lg border-l-4 ${player.color} ${
                  idx === 0 ? 'bg-yellow-50' : 'bg-gray-50'
                }`}
              >
                <div className="flex items-center gap-3">
                  <span className="text-2xl font-bold text-gray-600">#{idx + 1}</span>
                  <div>
                    <div className="font-bold text-lg">{player.name}</div>
                    <div className="text-sm text-gray-600">
                      Ë≥áÈáë: {player.funds}ÂÑÑÂÜÜ / ‰∫∫Âè£: {player.population}‰∫∫
                    </div>
                  </div>
                </div>
                <div className="text-right">
                  <div className="text-2xl font-bold text-blue-600">{player.score}</div>
                  <div className="text-xs text-gray-500">„Çπ„Ç≥„Ç¢</div>
                </div>
              </div>
            ))}
          </div>

          <button
            onClick={resetGame}
            className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-bold text-lg"
          >
            Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†„ÇíÈñãÂßã
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-100 to-green-100 p-8">
      <div className="max-w-7xl mx-auto">
        <h1 className="text-4xl font-bold text-center mb-2 text-gray-800">ÁÆ±Â∫≠Ë´∏Â≥∂ ÂØæÊà¶„É¢„Éº„Éâ</h1>
        <p className="text-center text-gray-600 mb-6">„Çø„Éº„É≥ {globalTurn}/20</p>

        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
          <div className="lg:col-span-3">
            <div className={`bg-white rounded-lg shadow-lg p-6 border-4 ${currentPlayer?.color || 'border-gray-300'}`}>
              <div className="flex justify-between items-center mb-4">
                <div>
                  <h2 className="text-2xl font-bold text-gray-800">{currentPlayer?.name}„ÅÆ„Çø„Éº„É≥</h2>
                  <p className="text-sm text-gray-600">Â≥∂„ÅÆÈñãÁô∫</p>
                </div>
                <div className="flex gap-4 text-sm">
                  <div className="flex items-center gap-1">
                    <DollarSign size={16} />
                    <span className="font-semibold">{currentPlayer?.funds}ÂÑÑÂÜÜ</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <Users size={16} />
                    <span className="font-semibold">{currentPlayer?.population}‰∫∫</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <Trophy size={16} />
                    <span className="font-semibold">{currentPlayer?.score}pts</span>
                  </div>
                </div>
              </div>

              <div className="inline-block border-4 border-gray-400 mb-4">
                {currentPlayer?.grid.map((row, y) => (
                  <div key={y} className="flex">
                    {row.map((cell, x) => (
                      <TerrainCell key={`${x}-${y}`} terrain={cell} x={x} y={y} />
                    ))}
                  </div>
                ))}
              </div>

              <div className="flex gap-2">
                <button
                  onClick={endTurn}
                  className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-semibold"
                >
                  „Çø„Éº„É≥ÁµÇ‰∫Ü
                </button>
              </div>
            </div>
          </div>

          <div className="space-y-6">
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h3 className="text-xl font-bold mb-4 text-gray-800">ÈñãÁô∫„Ç≥„Éû„É≥„Éâ</h3>
              <div className="space-y-2">
                {COMMANDS.map(cmd => (
                  <button
                    key={cmd.id}
                    onClick={() => setSelectedCommand(cmd.id)}
                    className={`w-full text-left p-3 rounded-lg border-2 transition-all ${
                      selectedCommand === cmd.id
                        ? 'border-blue-600 bg-blue-50'
                        : 'border-gray-200 hover:border-blue-300'
                    }`}
                  >
                    <div className="font-semibold text-sm">{cmd.name}</div>
                    <div className="text-xs text-gray-600">{cmd.description}</div>
                    <div className="text-xs text-gray-500 mt-1">Ë≤ªÁî®: {cmd.cost}ÂÑÑÂÜÜ</div>
                  </button>
                ))}
              </div>
            </div>

            <div className="bg-white rounded-lg shadow-lg p-6">
              <h3 className="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                <Trophy size={20} />
                „É©„É≥„Ç≠„É≥„Ç∞
              </h3>
              <div className="space-y-2">
                {rankedPlayers.map((player, idx) => (
                  <div
                    key={player.id}
                    className={`p-2 rounded-lg border-l-4 ${player.color} ${
                      player.id === currentPlayer?.id ? 'bg-blue-50' : 'bg-gray-50'
                    }`}
                  >
                    <div className="flex justify-between items-center">
                      <div>
                        <span className="font-bold">#{idx + 1}</span> {player.name}
                      </div>
                      <div className="text-sm font-bold text-blue-600">{player.score}</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-white rounded-lg shadow-lg p-6">
              <h3 className="text-xl font-bold mb-4 text-gray-800">„É≠„Ç∞</h3>
              <div className="space-y-1 text-xs max-h-48 overflow-y-auto">
                {logs.map((log, i) => (
                  <div key={i} className="text-gray-700 border-b border-gray-100 pb-1">
                    <span className="text-gray-500">[T{log.turn}]</span> {log.message}
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default HakoniwaIslands;
